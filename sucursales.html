<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
     <title>Sucursales de Rosso Materiales en Tucumán y Salta</title>
    <meta name="description" content="Encontrá la sucursal de Rosso Materiales más cercana. Tenemos locales en San Miguel de Tucumán, Salta Capital, Metán, Monteros, Concepción y más. ¡Visitános!">
    
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QBM51JZ19R"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-QBM51JZ19R');
    </script>


    <script src="https://cdn.tailwindcss.com"></script>
     <link href="assets/FAV.png" rel="icon">

    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
        rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <link href="style.css" rel="stylesheet" />

    <style>
        /* =============================================================== */
        /* ===== SOLUCIÓN PARA ESTA PÁGINA: SOBRESCRIBIR EL HEADER ===== */
        .main-header {
            position: relative !important; /* Forza al header a no ser fijo */
        }
        /* =============================================================== */

        body {
            font-family: "Inter", sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        .store-list::-webkit-scrollbar {
            width: 8px;
        }
        .store-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .store-list::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 10px;
        }
        .store-list::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        #detail-panel {
            transition: transform 0.3s ease-in-out;
            z-index: 2000;
        }

        @media (max-width: 767px) {
            #detail-panel {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }
        }

        .animated-marker {
            position: relative;
            width: 36px;
            height: 36px;
        }
        .animated-marker .pulse {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: rgba(234, 88, 12, 0.7);
            animation: pulse 2s infinite;
            z-index: 1;
        }
        .animated-marker .icon {
            position: absolute;
            top: 0;
            left: 0;
            width: 36px;
            height: 36px;
            z-index: 2;
        }

        @keyframes pulse {
            0% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0.7;
            }
            70% {
                transform: translate(-50%, -50%) scale(2.5);
                opacity: 0;
            }
            100% {
                transform: translate(-50%, -50%) scale(0.5);
                opacity: 0;
            }
        }

        /* ===== Horarios Desplegable Estético (v2) ===== */
        .horarios-toggle {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background-color: #ec6434;
            color: #fff;
            padding: 1px 8px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            user-select: none;
        }
        .horarios-toggle:hover {
            background-color: #241e77;
        }
        .horarios-toggle .icon {
            transition: transform 0.3s ease-in-out;
            width: 0.7rem;
            height: 0.7rem;
        }
        .horarios-detalle {
            background-color: #f9fafb;
            border-radius: 8px;
            margin-top: 10px;
            padding: 8px 12px;
        }
        .horarios-detalle ul {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }
        .horarios-detalle li {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            padding: 6px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .horarios-detalle li:last-child {
            border-bottom: none;
        }
        .horarios-detalle li span:first-child {
            color: #4b5563;
            font-weight: 500;
        }
        .horarios-detalle li span:last-child {
            color: #272e68;
            font-weight: 500;
        }
        .horarios-detalle li.today span {
            font-weight: 700;
            color: #1f244f;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">
    <header class="main-header" role="banner">
        <nav class="main-nav container" aria-label="Primaria">
            <a href="/" class="logo" aria-label="Ir al inicio">
                <img src="https://i.ibb.co/PzZscw0G/Logo-Rosso-Institucional-1.png" alt="Rosso Materiales" class="logo-image" />
            </a>
            <div class="nav-links" id="nav-links">
                <a href="https://rossomateriales.netlify.app"><i class="fa-solid fa-tags"></i> Promociones</a>
                <a href="https://catalogo.rossomateriales.site"><i class="fa-solid fa-book-open"></i> Catálogo</a>
                <a href="/sucursales"><i class="fa-solid fa-map-location-dot"></i> Sucursales</a>
                <a href="/nosotros"><i class="fa-solid fa-users"></i> Nosotros</a>
                <div class="dropdown">
                    <a href="#" class="dropdown-toggle"><i class="fa-solid fa-wrench"></i> Utilidades</a>
                    <div class="dropdown-menu">
                        <a href="calculadora.html">Calculá los m²</a>
                        <a href="checklist.html">Checklist de Materiales</a>
                        <a href="glosario.html">Glosario</a>
                    </div>
                </div>
            </div>
           
        </nav>
    </header>

    <div class="flex flex-col md:flex-row flex-grow md:overflow-hidden">
        <aside
            id="store-list-panel"
            class="w-full md:w-1/3 lg:w-1/4 bg-white shadow-lg flex flex-col transition-transform duration-300"
        >
            <header class="p-4 border-b">
                <h1 class="text-2xl font-bold text-blue-900 mb-4">
                    Nuestras sucursales
                </h1>
                <div class="mt-2 relative">
                    <input
                        type="text"
                        id="search-box"
                        placeholder="Buscar por cuidad, código pos..."
                        class="w-full pl-4 pr-24 py-2 border-transparent bg-gray-100 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
                    />
                    <button
                        id="search-button"
                        class="absolute right-1 top-1 bottom-1 px-4 bg-blue-900 text-white rounded-md text-sm font-semibold hover:bg-blue-800"
                    >
                        Buscar
                    </button>
                </div>
            </header>
            <div
                id="store-list-container"
                class="store-list flex-grow overflow-y-auto"
            >
                <div class="p-4 text-center text-gray-500">
                    Buscando tu ubicación para calcular distancias...
                </div>
            </div>
        </aside>

        <main class="relative w-full md:w-2/3 lg:w-3/4 h-full">
            <div id="map" class="w-full h-full"></div>

            <div
                id="detail-panel"
                class="absolute top-0 right-0 h-full w-full md:w-80 bg-white shadow-2xl p-4 transform translate-x-full overflow-y-auto"
            >
                <button
                    id="close-panel-btn"
                    class="absolute top-3 right-3 text-gray-500 hover:text-gray-800 z-10"
                >
                    <svg
                        xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke="currentColor"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"
                        />
                    </svg>
                </button>
                <div id="detail-content" class="mt-6"></div>
            </div>
        </main>
    </div>

    <script>
        // --- DATOS DE LAS SUCURSALES ---
        const stores = [
            // --- SUC.EL MANANTIAL ---
            {
                id: "manantial",
                name: "Rosso Materiales - El Manantial",
                address: "km 0.6, RP301, San Miguel de Tucumán, Tucumán",
                phone: "381-4146917",
                whatsappNumber: "5493814146917",
                lat: -26.8368596951598, 
                lng: -65.26288875539471,
                imageUrl:
                    "https://i.ibb.co/dswSsMvY/IMG-2644-1.jpg",
                websiteUrl: "rossomateriales.site",
                schedule: {
                    1: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "14:30",
                        pm_close: "17:30",
                    },
                    2: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "14:30",
                        pm_close: "17:30",
                    },
                    3: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "14:30",
                        pm_close: "17:30",
                    },
                    4: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "14:30",
                        pm_close: "17:30",
                    },
                    5: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "14:30",
                        pm_close: "17:30",
                    },
                    6: { am_open: "08:30", am_close: "13:00" },
                },
            },
            // --- SUC.SALTA ---
            {
                id: "salta",
                name: "Rosso Materiales - Salta",
                address: "Av. Chile 1474, A4400 Salta",
                phone: "381-4146917",
                whatsappNumber: "5493814146917",
                lat: -24.80774,  
                lng: -65.41841,
                imageUrl: "https://i.ibb.co/FSnw3QV/Whats-App-Image-2025-08-29-at-5-50-13-PM.jpg",
                websiteUrl: "rossomateriales.site",
                schedule: {
                    1: {
                        am_open: "09:00",
                        am_close: "13:00",
                        pm_open: "14:00",
                        pm_close: "18:00",
                    },
                    2: {
                        am_open: "09:00",
                        am_close: "13:00",
                        pm_open: "14:00",
                        pm_close: "18:00",
                    },
                    3: {
                        am_open: "09:00",
                        am_close: "13:00",
                        pm_open: "14:00",
                        pm_close: "18:00",
                    },
                    4: {
                        am_open: "09:00",
                        am_close: "13:00",
                        pm_open: "14:00",
                        pm_close: "18:00",
                    },
                    5: {
                        am_open: "09:00",
                        am_close: "13:00",
                        pm_open: "14:00",
                        pm_close: "18:00",
                    },
                    6: { am_open: "08:30", am_close: "13:00" },
                },
            },
            // --- SUC.METAN ---
            {
                id: "metan",
                name: "Rosso Materiales - Metán",
                address: "Tucuman, Cnel. Vidt esq, A4440 San José de Metán, Salta",
                phone: "381-4146917",
                whatsappNumber: "5493814146917",
                lat: -25.505431529399463,   
                lng: -64.97209097627173,
                imageUrl: "https://i.ibb.co/kV9TpKXW/IMG-7990.webp",
                websiteUrl: "rossomateriales.site",
                schedule: {
                    1: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    2: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    3: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    4: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    5: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    6: { am_open: "08:30", am_close: "13:00" },
                },
            },
            // --- SUC.MONTEROS ---
            {
                id: "monteros",
                name: "Rosso Materiales - Monteros",
                address: "Juan Bautista Alberdi 53, T4142 BWB, Tucumán",
                phone: "381-4146917",
                whatsappNumber: "5493814146917",
                lat: -27.17127479138811,
                lng: -65.49710679446056,
                imageUrl: "https://i.ibb.co/rf1XnWyT/IMG-2050-1.webp",
                websiteUrl: "rossomateriales.site",
                schedule: {
                    1: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    2: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    3: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    4: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    5: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    6: { am_open: "08:30", am_close: "13:00" },
                },
            },
            // --- SUC.CONCEPCION ---
            {
                id: "concepcion",
                name: "Rosso Materiales - Concepción",
                address: "Padre Carlos Juangorena 1850, T4146 Concepción, Tucumán",
                phone: "381-4146917",
                whatsappNumber: "5493814146917",
                lat: -27.346295070752795,
                lng: -65.59767583019305,
                imageUrl:
                    "https://i.ibb.co/HT9Pd23W/Whats-App-Image-2025-09-08-at-12-41-10-PM.jpg",
                websiteUrl: "rossomateriales.site",
                schedule: {
                    1: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "14:30",
                        pm_close: "17:30",
                    },
                    2: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "14:30",
                        pm_close: "17:30",
                    },
                    3: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "14:30",
                        pm_close: "17:30",
                    },
                    4: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "14:30",
                        pm_close: "17:30",
                    },
                    5: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "14:30",
                        pm_close: "17:30",
                    },
                    6: { am_open: "08:30", am_close: "13:00" },
                },
            },
            // --- SUC.JB.ALBERDI ---
            {
                id: "alberdi",
                name: "Rosso Materiales - J.B. Alberdi",
                address: "Ricardo Rojas, C. Monteagudo y, T4185 Juan Bautista Alberdi, Tucumán",
                phone: "381-4146917",
                whatsappNumber: "5493814146917",
                lat: -27.56517318880546,
                lng: -65.6120588936078,
                imageUrl: "https://i.ibb.co/dN6x4ww/DJI-20231206-083139-798.webp",
                websiteUrl: "rossomateriales.site",
                schedule: {
                    1: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    2: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    3: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    4: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    5: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    6: { am_open: "08:30", am_close: "13:00" },
                },
            },
            // --- SUC.AGUILARES ---
            {
                id: "aguilares",
                name: "Rosso Materiales - Aguilares",
                address: "Av. Sarmiento 739, T4152 Aguilares, Tucumán",
                phone: "381-4146917",
                whatsappNumber: "5493814146917",
                lat: -27.428411714357022,
                lng: -65.61438190020249,
                imageUrl: "https://i.ibb.co/s9Xkh8zX/IMG-3182.webp",
                websiteUrl: "rossomateriales.site",
                schedule: {
                    1: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    2: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    3: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    4: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    5: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    6: { am_open: "08:30", am_close: "13:00" },
                },
            },
            // --- SUC.FAMAILLA ---
            {
                id: "famailla",
                name: "Rosso Materiales - Famailla",
                address: "Av. Calchaquí y, Larrea 106, T4132 Famaillá, Tucumán",
                phone: "381-4146917",
                whatsappNumber: "543814146917",
                lat: -27.062898394516886,
                lng: -65.40283673204807,
                imageUrl:
                    "https://i.ibb.co/67D9zWdN/Whats-App-Image-2025-08-26-at-4-22-13-PM-1.webp",
                websiteUrl: "rossomateriales.site",
                schedule: {
                    1: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    2: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    3: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    4: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    5: {
                        am_open: "08:00",
                        am_close: "13:00",
                        pm_open: "15:00",
                        pm_close: "18:00",
                    },
                    6: { am_open: "08:30", am_close: "13:00" },
                },
            },
            // --- SUC.TAFI DEL VALLE ---
            {
                id: "tafidelvalle",
                name: "Rosso Materiales - Tafi del Valle",
                address: "Km. 60.5 Ruta P. 307, T4137 Tafí del Valle, Tucumán",
                phone: "381-4146917",
                whatsappNumber: "5493814146917",
                lat: -26.85749368894493,
                lng: -65.6960278339007,
                imageUrl:
                    "https://i.ibb.co/27Z8zz7T/Whats-App-Image-2025-07-04-at-9-47-52-AM.jpg",
                websiteUrl: "rossomateriales.site",
                schedule: {
                    1: {
                        am_open: "08:00",
                        am_close: "12:30",
                        pm_open: "14:00",
                        pm_close: "17:30",
                    },
                    2: {
                        am_open: "08:00",
                        am_close: "12:30",
                        pm_open: "14:00",
                        pm_close: "17:30",
                    },
                    3: {
                        am_open: "08:00",
                        am_close: "12:30",
                        pm_open: "14:00",
                        pm_close: "17:30",
                    },
                    4: {
                        am_open: "08:00",
                        am_close: "12:30",
                        pm_open: "14:00",
                        pm_close: "17:30",
                    },
                    5: {
                        am_open: "08:00",
                        am_close: "12:30",
                        pm_open: "14:00",
                        pm_close: "17:30",
                    },
                    6: { am_open: "08:30", am_close: "13:00" },
                },
            },
        ];
        // --- FUNCIÓN PARA FORMATEAR HORARIOS ---
        const formatSchedule = (schedule) => {
            const days = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
            const todayIndex = new Date().getDay();
            let html = '<ul>';
            // Lunes a Sábado
            for (let i = 1; i <= 6; i++) {
                const dayHours = schedule[i];
                const isToday = i === todayIndex;
                html += `<li class="${isToday ? 'today' : ''}">`;
                html += `<span>${days[i]}</span>`;
                if (dayHours) {
                    let hoursText = `${dayHours.am_open} - ${dayHours.am_close}`;
                    if (dayHours.pm_open) {
                        hoursText += `  •  ${dayHours.pm_open} - ${dayHours.pm_close}`;
                    }
                    html += `<span>${hoursText}</span>`;
                } else {
                    html += '<span>Cerrado</span>';
                }
                html += '</li>';
            }
            // Domingo
            html += `<li class="${todayIndex === 0 ? 'today' : ''}"><span>Domingo</span><span>Cerrado</span></li>`;
            html += '</ul>';
            return html;
        };
        // --- INICIALIZACIÓN Y ELEMENTOS DEL DOM ---
        const map = L.map("map").setView([-26.5, -65.3], 8);
        L.tileLayer(
            "https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png",
            { maxZoom: 19, attribution: "© OpenStreetMap © CARTO" }
        ).addTo(map);

        const storeListPanel = document.getElementById("store-list-panel");
        const storeListContainer = document.getElementById(
            "store-list-container"
        );
        const detailPanel = document.getElementById("detail-panel");
        const detailContent = document.getElementById("detail-content");
        const closePanelBtn = document.getElementById("close-panel-btn");
        const searchBox = document.getElementById("search-box");
        const searchButton = document.getElementById("search-button");

        const markers = {};
        const markersLayer = L.layerGroup().addTo(map);
        let miniMap = null;

        // --- FUNCIONES ---
        const calculateDistance = (lat1, lon1, lat2, lon2) =>
            6371 *
            2 *
            Math.atan2(
                Math.sqrt(
                    Math.sin(((lat2 - lat1) * Math.PI) / 180 / 2) *
                        Math.sin(((lat2 - lat1) * Math.PI) / 180 / 2) +
                        Math.cos((lat1 * Math.PI) / 180) *
                            Math.cos((lat2 * Math.PI) / 180) *
                            Math.sin(((lon2 - lon1) * Math.PI) / 180 / 2) *
                            Math.sin(((lon2 - lon1) * Math.PI) / 180 / 2)
                ),
                Math.sqrt(
                    1 -
                        (Math.sin(((lat2 - lat1) * Math.PI) / 180 / 2) *
                            Math.sin(((lat2 - lat1) * Math.PI) / 180 / 2) +
                            Math.cos((lat1 * Math.PI) / 180) *
                                Math.cos((lat2 * Math.PI) / 180) *
                                Math.sin(((lon2 - lon1) * Math.PI) / 180 / 2) *
                                Math.sin(((lon2 - lon1) * Math.PI) / 180 / 2))
                )
            );

        // --- FUNCIÓN getStoreStatus ACTUALIZADA ---
        const getStoreStatus = (schedule) => {
            const now = new Date();
            const dayOfWeek = now.getDay();
            const todaysHours = schedule[dayOfWeek];

            if (!todaysHours) {
                return { status: "Cerrado hoy", statusColor: "text-red-600" };
            }

            const createDate = (timeStr) => {
                if (!timeStr) return null;
                const [hour, minute] = timeStr.split(":").map(Number);
                const date = new Date();
                date.setHours(hour, minute, 0, 0);
                return date;
            };

            const amOpenTime = createDate(todaysHours.am_open);
            const amCloseTime = createDate(todaysHours.am_close);
            const pmOpenTime = createDate(todaysHours.pm_open);
            const pmCloseTime = createDate(todaysHours.pm_close);

            // Turno mañana
            if (
                amOpenTime &&
                amCloseTime &&
                now >= amOpenTime &&
                now < amCloseTime
            ) {
                return {
                    status: `Abierto hasta las ${todaysHours.am_close}`,
                    statusColor: "text-green-600",
                };
            }

            // Turno tarde
            if (
                pmOpenTime &&
                pmCloseTime &&
                now >= pmOpenTime &&
                now < pmCloseTime
            ) {
                return {
                    status: `Abierto hasta las ${todaysHours.pm_close}`,
                    statusColor: "text-green-600",
                };
            }

            // Si está cerrado, vemos cuándo abre
            if (amOpenTime && now < amOpenTime) {
                return {
                    status: `Cerrado, abre a las ${todaysHours.am_open}`,
                    statusColor: "text-red-600",
                };
            }

            if (pmOpenTime && now >= amCloseTime && now < pmOpenTime) {
                return {
                    status: `Cerrado, abre a las ${todaysHours.pm_open}`,
                    statusColor: "text-red-600",
                };
            }

            return { status: "Cerrado por hoy", statusColor: "text-red-600" };
        };

        const openDetailPanel = (store) => {
            if (miniMap) {
                miniMap.remove();
                miniMap = null;
            }
            const showMiniMap = window.innerWidth < 768;
            const miniMapHTML = showMiniMap
                ? `<div id="mini-map" class="w-full h-48 mt-4 rounded-lg z-0"></div>`
                : "";
            // --- LÍNEA DE HORARIO MODIFICADA EN EL PANEL DE DETALLE ---
            detailContent.innerHTML = `<img src="${store.imageUrl}" alt="Foto de ${store.name}" class="w-full h-40 object-cover rounded-lg shadow-md" onerror="this.onerror=null;this.src='https://placehold.co/400x300/cccccc/ffffff?text=...';"><h2 class="text-2xl font-bold text-gray-900 mt-4">${store.name}</h2><div class="mt-4 space-y-3"><a href="https://wa.me/${store.whatsappNumber}" target="_blank" class="flex items-center justify-center w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">WhatsApp</a><a href="https://www.google.com/maps/dir/?api=1&destination=${store.lat},${store.lng}" target="_blank" class="flex items-center justify-center w-full bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">Cómo llegar</a></div><div class="mt-4 space-y-4 text-gray-700"><div class="flex items-start space-x-3"><span class="mt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z" /></svg></span><p>${store.phone}</p></div><div class="flex items-start space-x-3"><span class="mt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" /></svg></span><p>${store.address}</p></div><div class="flex items-start space-x-3"><span class="mt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C3.732 4.943 10 2.5 10 2.5s6.268 2.443 9.542 7.5c-3.274 5.057-9.542 7.5-9.542 7.5S3.732 15.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg></span><a href="https://${store.websiteUrl}" target="_blank" class="text-gray-500 hover:underline">${store.websiteUrl}</a></div><div class="flex items-start space-x-3"><span class="mt-1"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd" /></svg></span><p class="${store.statusColor} font-semibold">${store.status}</p></div></div>${miniMapHTML}`;
            if (window.innerWidth < 768) {
                storeListPanel.classList.add("-translate-x-full");
            }
            detailPanel.classList.remove("translate-x-full");
            if (showMiniMap) {
                setTimeout(() => {
                    miniMap = L.map("mini-map", {
                        center: [store.lat, store.lng],
                        zoom: 15,
                        dragging: false,
                        zoomControl: false,
                        scrollWheelZoom: false,
                        doubleClickZoom: false,
                        touchZoom: false,
                    });
                    L.tileLayer(
                        "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png"
                    ).addTo(miniMap);
                    L.marker([store.lat, store.lng]).addTo(miniMap);
                }, 300);
            }
        };

        const closeDetailPanel = () => {
            detailPanel.classList.add("translate-x-full");
            storeListPanel.classList.remove("-translate-x-full");
            document
                .querySelectorAll(".store-item")
                .forEach((el) => el.classList.remove("bg-gray-100"));
            if (miniMap) {
                miniMap.remove();
                miniMap = null;
            }
        };

        const renderStores = (storeData) => {
            markersLayer.clearLayers();
            storeListContainer.innerHTML = "";
            if (storeData.length === 0)
                storeListContainer.innerHTML = `<div class="p-4 text-center text-gray-500">No se encontraron sucursales.</div>`;
            
            storeData.forEach((store) => {
                const statusInfo = getStoreStatus(store.schedule);
                store.status = statusInfo.status;
                store.statusColor = statusInfo.statusColor;
                const distanceText = store.distance ? `<strong class="text-blue-900">${store.distance.toFixed(1)} km</strong>` : "";
                const animatedIcon = L.divIcon({
                    className: "animated-marker",
                    html: `<div class="pulse"></div><div class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="#EA580C"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.5 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg></div>`,
                    iconSize: [36, 36],
                    iconAnchor: [18, 36],
                });
                const marker = L.marker([store.lat, store.lng], { icon: animatedIcon });
                marker.on("click", () => { document.getElementById(`store-${store.id}`).click(); });
                markersLayer.addLayer(marker);

                const storeElement = document.createElement("div");
                storeElement.id = `store-${store.id}`;
                storeElement.className = "store-item p-4 border-b hover:bg-gray-50 transition-colors duration-200";
                
                const horariosHTML = formatSchedule(store.schedule);

                storeElement.innerHTML = `
                    <div class="flex space-x-4">
                        <img src="${store.imageUrl}" alt="Foto de ${store.name}" class="w-20 h-24 object-cover rounded-md flex-shrink-0" onerror="this.onerror=null;this.src='https://placehold.co/200x200/cccccc/ffffff?text=...';">
                        <div class="text-sm flex-grow">
                            <h2 class="font-semibold text-blue-900 cursor-pointer">${store.name}</h2>
                            <p class="cursor-pointer">
                                ${distanceText} <span class="text-gray-500">•</span> 
                                <span class="${store.statusColor} font-semibold">${store.status}</span>
                            </p>
                            <p class="text-gray-500 cursor-pointer text-xs mt-1">${store.address}</p>
                            
                            <div class="flex items-center justify-between mt-1 md:mt-2">
                                <p class="text-gray-500 cursor-pointer text-xs m-0">${store.phone}</p>
                                <span class="horarios-toggle">
                                    Ver horarios
                                    <svg class="icon" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" height="1em" width="1em" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"></path></svg>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="horarios-wrapper" style="max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out;">
                        <div class="horarios-detalle">
                            ${horariosHTML}
                        </div>
                    </div>
                `;
                
                storeElement.addEventListener("click", (e) => {
                    if (e.target.closest('.horarios-toggle')) return;
                    map.flyTo([store.lat, store.lng], 15);
                    openDetailPanel(store);
                    document.querySelectorAll(".store-item").forEach((el) => el.classList.remove("bg-gray-100"));
                    storeElement.classList.add("bg-gray-100");
                });

                storeListContainer.appendChild(storeElement);
                
                const horariosToggle = storeElement.querySelector('.horarios-toggle');
                const horariosWrapper = storeElement.querySelector('.horarios-wrapper');
                const icon = horariosToggle.querySelector('.icon');

                horariosToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isOpen = horariosWrapper.style.maxHeight !== '0px';
                    if (isOpen) {
                        horariosWrapper.style.maxHeight = '0px';
                        icon.style.transform = 'rotate(0deg)';
                    } else {
                        horariosWrapper.style.maxHeight = horariosWrapper.scrollHeight + 'px';
                        icon.style.transform = 'rotate(180deg)';
                        
                        // ===== LA MAGIA ESTÁ AQUÍ =====
                        // Esperamos un poquito a que la animación de abrir empiece
                        // y luego hacemos scroll para que se vea.
                        setTimeout(() => {
                            storeElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 300); // 300 milisegundos
                    }
                });
            });
        };
        // --- LÓGICA PRINCIPAL Y EVENTOS ---
        const filterStores = () => {
            const searchTerm = searchBox.value.toLowerCase();
            const filteredStores = stores.filter(
                (store) =>
                    store.name.toLowerCase().includes(searchTerm) ||
                    store.address.toLowerCase().includes(searchTerm)
            );
            renderStores(filteredStores);
        };

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const userLat = position.coords.latitude;
                const userLng = position.coords.longitude;
                stores.forEach(
                    (store) =>
                        (store.distance = calculateDistance(
                            userLat,
                            userLng,
                            store.lat,
                            store.lng
                        ))
                );
                // stores.sort((a, b) => a.distance - b.distance);
                renderStores(stores);
            },
            () => {
                console.warn(
                    "No se pudo obtener la ubicación. Mostrando lista sin ordenar por distancia."
                );
                renderStores(stores);
            }
        );

        searchButton.addEventListener("click", filterStores);
        searchBox.addEventListener("input", filterStores);
        closePanelBtn.addEventListener("click", closeDetailPanel);
        map.on("click", closeDetailPanel);
    </script>
</body>
</html>