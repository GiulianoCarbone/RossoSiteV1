<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Administraci贸n | Rosso Materiales</title>
    <link href="assets/FAV.png" rel="icon" />
    <link href="style.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <!-- jsPDF and AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.21/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Fix: Unregister any Service Workers that might be causing Firestore errors on this page
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                for (let registration of registrations) {
                    console.log('Unregistering Service Worker:', registration);
                    registration.unregister();
                }
            });
        }
    </script>
    <style>
        :root {
            --panel-bg: #f4f7f6;
            --card-bg: #ffffff;
            --sidebar-bg: #1f2937;
            --sidebar-text: #f3f4f6;
            --accent: #d95324;
            --brand: #1a1a1a;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            height: 100%;
            background-color: var(--panel-bg);
            font-family: "Inter", sans-serif;
        }

        /* Login Overlay */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        #login-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        #login-container img.logo {
            max-width: 180px;
            margin-bottom: 24px;
            margin-inline: auto;
        }

        .input-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            background-color: var(--accent);
            color: white;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #bd461e;
        }

        #login-error {
            color: #d9534f;
            margin-top: 15px;
            font-weight: 600;
            min-height: 20px;
        }

        /* Admin Layout */
        #admin-wrapper {
            display: none;
            /* Initially hidden */
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* Sidebar */
        #sidebar {
            width: 250px;
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #374151;
        }

        .sidebar-header h2 {
            margin: 0;
            font-size: 1.2rem;
            color: white;
        }

        #mobile-menu-toggle {
            display: none;
            /* Hidden on desktop */
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .sidebar-nav {
            flex: 1;
            padding: 20px 0;
            overflow-y: auto;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: #9ca3af;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-item:hover,
        .nav-item.active {
            background-color: #374151;
            color: white;
        }

        .nav-item i {
            margin-right: 15px;
            width: 20px;
            text-align: center;
        }

        .sidebar-footer {
            padding: 20px;
            border-top: 1px solid #374151;
        }

        .logout-btn {
            background-color: transparent;
            border: 1px solid #4b5563;
            color: #9ca3af;
        }

        .logout-btn:hover {
            background-color: #374151;
            color: white;
        }

        /* Main Content */
        #main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background-color: #f3f4f6;
        }

        .content-section {
            display: none;
            max-width: 1000px;
            margin: 0 auto;
        }

        .content-section.active {
            display: block;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .section-header h1 {
            margin: 0;
            color: var(--brand);
            font-size: 2rem;
        }

        /* Cards & Lists */
        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }

        .admin-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .admin-item {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 15px;
            background: #f9fafb;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .admin-item-content {
            flex-grow: 1;
        }

        .admin-item-content p {
            margin: 5px 0 0;
            color: #374151;
        }

        .admin-item-content small {
            color: var(--accent);
            font-weight: 600;
        }

        .admin-item-actions {
            display: flex;
            gap: 8px;
            flex-shrink: 0;
        }

        .action-btn {
            width: 36px;
            height: 36px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
        }

        .btn-edit {
            background-color: #007bff;
        }

        .btn-delete {
            background-color: #dc3545;
        }

        .btn-reset {
            background-color: #6c757d;
        }

        /* Active Users */
        #active-users-display {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        #active-users-count {
            font-weight: 800;
            color: #4f46e5;
        }

        #active-users-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .user-tag {
            background-color: #e0e7ff;
            color: #3730a3;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            width: auto;
            padding: 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #admin-wrapper {
                flex-direction: column;
            }

            #sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                align-items: center;
                padding: 10px;
                justify-content: space-between;
            }

            .sidebar-header {
                border: none;
                padding: 0;
                text-align: left;
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
            }

            #mobile-menu-toggle {
                display: block;
                /* Visible on mobile */
            }

            .sidebar-nav {
                display: none;
                position: absolute;
                top: 60px;
                left: 0;
                width: 100%;
                background: var(--sidebar-bg);
                z-index: 100;
            }

            .sidebar-nav.mobile-open {
                display: block;
            }

            .sidebar-footer {
                display: none;
            }

            #main-content {
                padding: 20px;
            }
        }
    </style>
</head>

<body>

    <!-- LOGIN SCREEN -->
    <div id="login-overlay">
        <div id="login-container">
            <img src="https://i.ibb.co/PzZscw0G/Logo-Rosso-Institucional-1.png" alt="Rosso Materiales Logo"
                class="logo" />
            <h2>Acceso Administrativo</h2>
            <form id="admin-login-form">
                <div class="input-group">
                    <label for="admin-password">Contrase帽a</label>
                    <input type="password" id="admin-password" placeholder="Ingrese c贸digo de acceso" required />
                </div>
                <button type="submit">Ingresar</button>
                <div id="login-error"></div>
            </form>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <div id="admin-wrapper" style="display: none;">
        <!-- Sidebar -->
        <nav id="sidebar">
            <div class="sidebar-header">
                <h2>Panel Admin</h2>
                <button id="mobile-menu-toggle"><i class="fa-solid fa-bars"></i></button>
            </div>
            <div class="sidebar-nav">
                <a class="nav-item active" data-section="dashboard">
                    <i class="fa-solid fa-gauge"></i> Dashboard
                </a>
                <a class="nav-item" data-section="notifications">
                    <i class="fa-solid fa-bell"></i> Notificaciones
                </a>
                <a class="nav-item" data-section="news">
                    <i class="fa-solid fa-bullhorn"></i> Noticias
                </a>
                <a class="nav-item" data-section="trainings">
                    <i class="fa-solid fa-graduation-cap"></i> Capacitaciones
                </a>
                <a class="nav-item" data-section="suggestions">
                    <i class="fa-solid fa-envelope-open-text"></i> Sugerencias
                </a>
                <a class="nav-item" data-section="vendedores">
                    <i class="fa-solid fa-users-cog"></i> Vendedores
                </a>

                <a class="nav-item" data-section="social-config">
                    <i class="fa-solid fa-share-nodes"></i> Redes Sociales
                </a>
                <a class="nav-item" data-section="review-config">
                    <i class="fa-solid fa-star"></i> Rese帽a Destacada
                </a>
                <!-- Link to go back to main site -->
                <a href="panel-corporativo.html" class="nav-item">
                    <i class="fa-solid fa-arrow-right-from-bracket"></i> Volver al Sitio
                </a>
            </div>
            <div class="sidebar-footer">
                <button id="logout-btn" class="logout-btn">
                    <i class="fa-solid fa-right-from-bracket"></i> Cerrar Sesi贸n
                </button>
            </div>
        </nav>

        <!-- Content -->
        <main id="main-content">

            <!-- DASHBOARD SECTION -->
            <section id="dashboard" class="content-section active">
                <div class="section-header">
                    <h1>Dashboard</h1>
                </div>
                <div class="card">
                    <h3><i class="fa-solid fa-users"></i> Usuarios Activos</h3>
                    <div id="active-users-display">
                        <span id="active-users-count">0</span>
                        <span>conectados ahora</span>
                    </div>
                    <div id="active-users-list">
                        <!-- Users populated here -->
                    </div>
                    <button onclick="openConnectedTodayModal()"
                        style="margin-top: 15px; width: auto; background-color: #4f46e5;">
                        <i class="fa-solid fa-clock-rotate-left"></i> Ver Conectados Hoy
                    </button>
                </div>
                <div class="card">
                    <h3>Accesos R谩pidos</h3>
                    <div class="quick-actions-grid">
                        <button onclick="openNewsModalAction()" class="quick-action-card action-news">
                            <div class="icon-wrapper"><i class="fa-solid fa-bullhorn"></i></div>
                            <span>Nueva Noticia</span>
                        </button>
                        <button onclick="openNotificationModalAction()" class="quick-action-card action-notifications">
                            <div class="icon-wrapper"><i class="fa-solid fa-bell"></i></div>
                            <span>Nueva Notificaci贸n</span>
                        </button>
                        <button onclick="openTrainingModalAction()" class="quick-action-card action-training">
                            <div class="icon-wrapper"><i class="fa-solid fa-calendar-plus"></i></div>
                            <span>Agregar Fecha</span>
                        </button>
                        <button onclick="switchSection('suggestions')" class="quick-action-card action-suggestions">
                            <div class="icon-wrapper"><i class="fa-solid fa-envelope-open-text"></i></div>
                            <span>Ver Sugerencias</span>
                        </button>
                        <button onclick="switchSection('social-config')" class="quick-action-card action-configure">
                            <div class="icon-wrapper"><i class="fa-solid fa-share-nodes"></i></div>
                            <span>Configurar Redes</span>
                        </button>
                        <a href="carga-masiva.html" target="_blank" class="quick-action-card action-vendors">
                            <div class="icon-wrapper"><i class="fa-solid fa-users-cog"></i></div>
                            <span>Gestionar Vendedores</span>
                        </a>
                    </div>

                    <style>
                        .quick-actions-grid {
                            display: grid;
                            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                            /* Reduced min-width to fit 2 cols on mobile */
                            gap: 12px;
                            /* Slightly reduced gap */
                            margin-top: 20px;
                        }

                        .quick-action-card {
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            justify-content: center;
                            padding: 15px;
                            border-radius: 12px;
                            border: 1px solid #e5e7eb;
                            background-color: #ffffff;
                            text-decoration: none;
                            color: #1f2937;
                            font-weight: 600;
                            font-size: 0.95rem;
                            cursor: pointer;
                            transition: transform 0.2s, box-shadow 0.2s, border-color 0.2s;
                            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
                            text-align: center;
                            height: 100%;
                            min-height: 100px;
                        }

                        .quick-action-card:hover {
                            transform: translateY(-3px);
                            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
                            border-color: #d95324;
                            background-color: #ffffff !important;
                            /* Force white background to override button:hover */
                            color: #1f2937;
                            /* Ensure text stays dark */
                        }

                        .quick-action-card .icon-wrapper {
                            font-size: 1.5rem;
                            margin-bottom: 8px;
                            color: #d95324;
                        }
                    </style>
                </div>
            </section>

            <!-- VENDEDORES SECTION -->
            <section id="vendedores" class="content-section">
                <div class="section-header">
                    <h1>Gesti贸n de Vendedores</h1>
                </div>
                <div class="card">
                    <p style="margin-bottom: 20px; color: #4b5563;">Desde aqu铆 pod茅s acceder a la herramienta de carga
                        masiva y gesti贸n de vendedores.</p>
                    <a href="carga-masiva.html" target="_blank" class="admin-btn" style="
                      background-color: #007bff;
                      display: inline-flex;
                      align-items: center;
                      gap: 10px;
                      text-decoration: none;
                      padding: 12px 24px;
                      border-radius: 8px;
                      font-weight: 700;
                      color: white;
                    ">
                        <i class="fa-solid fa-users-cog"></i> Ir a Gesti贸n de Vendedores
                    </a>
                </div>
            </section>

            <!-- NEWS SECTION -->
            <section id="news" class="content-section">
                <div class="section-header">
                    <h1>Gesti贸n de Noticias</h1>
                    <button id="add-news-btn" style="width: auto;"><i class="fa-solid fa-plus"></i> Nueva
                        Noticia</button>
                </div>
                <div id="admin-news-list" class="admin-list">
                    <!-- News items populated here -->
                </div>
            </section>

            <!-- TRAININGS SECTION -->
            <section id="trainings" class="content-section">
                <div class="section-header">
                    <h1>Gesti贸n de Capacitaciones</h1>
                    <button id="add-training-btn" style="width: auto;"><i class="fa-solid fa-plus"></i> Agregar
                        Fecha</button>
                </div>
                <div id="admin-trainings-list" class="admin-list">
                    <!-- Trainings populated here -->
                </div>
            </section>

            <!-- SUGGESTIONS SECTION -->
            <section id="suggestions" class="content-section">
                <div class="section-header">
                    <h1>Buz贸n de Sugerencias</h1>
                </div>
                <div id="admin-suggestions-list" class="admin-list">
                    <!-- Suggestions populated here -->
                </div>
            </section>

            <!-- NOTIFICATIONS SECTION -->
            <section id="notifications" class="content-section">
                <div class="section-header">
                    <h1>Gesti贸n de Notificaciones</h1>
                    <button id="add-notification-btn" style="width: auto;"><i class="fa-solid fa-plus"></i> Nueva
                        Notificaci贸n</button>
                </div>
                <div id="admin-notifications-list" class="admin-list">
                    <!-- Notifications populated here -->
                </div>
            </section>

            <!-- SOCIAL CONFIG SECTION -->
            <section id="social-config" class="content-section">
                <div class="section-header">
                    <h1>Configurar Redes Sociales</h1>
                </div>
                <div class="panel-card" style="padding: 20px; max-width: 600px;">
                    <form id="social-config-form">
                        <div class="input-group">
                            <label>URL Imagen del Post</label>
                            <input type="url" id="social-image-url" placeholder="https://..." required>
                            <small>Link directo a la imagen que queres mostrar.</small>
                        </div>
                        <div class="input-group">
                            <label>Link Instagram</label>
                            <input type="url" id="social-instagram-url" placeholder="https://instagram.com/...">
                        </div>
                        <div class="input-group">
                            <label>Link Facebook</label>
                            <input type="url" id="social-facebook-url" placeholder="https://facebook.com/...">
                        </div>
                        <div class="input-group">
                            <label>Link LinkedIn</label>
                            <input type="url" id="social-linkedin-url" placeholder="https://linkedin.com/...">
                        </div>
                        <button type="submit" style="margin-top: 10px;">Guardar Configuraci贸n</button>
                    </form>
                </div>
            </section>

            <!-- REVIEW CONFIG SECTION -->
            <section id="review-config" class="content-section">
                <div class="section-header">
                    <h1>Configurar Rese帽a Destacada</h1>
                </div>
                <div class="panel-card" style="padding: 20px; max-width: 600px;">
                    <p style="color: #6b7280; margin-bottom: 20px;">
                        Configura la imagen y el mensaje de felicitaci贸n para la rese帽a destacada del mes.
                    </p>
                    <form id="review-config-form">
                        <div class="input-group">
                            <label>URL Imagen de la Rese帽a</label>
                            <input type="url" id="review-image-url" placeholder="https://..." required>
                            <small>Link directo a la captura de pantalla de la rese帽a de Google Maps.</small>
                        </div>
                        <div class="input-group">
                            <label>Nombre de la Sucursal</label>
                            <input type="text" id="review-branch-name-input" placeholder="Ej: Sucursal Salta" required>
                            <small>Nombre de la sucursal que recibi贸 la rese帽a destacada.</small>
                        </div>
                        <button type="submit" style="margin-top: 10px;">Guardar Configuraci贸n</button>
                    </form>
                </div>
            </section>

        </main>
    </div>

    <!-- MODAL: NEWS FORM -->
    <div id="news-form-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="news-form-title">Crear Noticia</h4>
                <button class="close-modal" onclick="closeModal('news-form-modal')">&times;</button>
            </div>
            <form id="news-form">
                <input type="hidden" id="news-id-field" />
                <div class="input-group">
                    <label>T铆tulo</label>
                    <input type="text" id="news-title-field" required />
                </div>
                <div class="input-group">
                    <label>Descripci贸n</label>
                    <textarea id="news-description-field" rows="4" required></textarea>
                </div>
                <div class="input-group">
                    <label>Link / Enlace (Opcional)</label>
                    <input type="url" id="news-link-field" placeholder="https://..." />
                </div>
                <div class="input-group">
                    <label>Categor铆a</label>
                    <select id="news-category-field" required>
                        <option value="comerciales">Comerciales</option>
                        <option value="rrhh">Recursos Humanos</option>
                    </select>
                </div>
                <button type="submit">Guardar Noticia</button>
            </form>
        </div>
    </div>

    <!-- MODAL: TRAINING FORM -->
    <div id="training-form-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="training-form-title">Agregar Capacitaci贸n</h4>
                <button class="close-modal" onclick="closeModal('training-form-modal')">&times;</button>
            </div>
            <form id="training-form">
                <input type="hidden" id="training-id-field" />
                <div class="input-group">
                    <label>Fecha</label>
                    <input type="date" id="training-date-field" required />
                </div>
                <div class="input-group">
                    <label>T铆tulo / Descripci贸n</label>
                    <input type="text" id="training-title-field" required />
                </div>
                <button type="submit">Guardar Evento</button>
            </form>
        </div>
    </div>

    <!-- MODAL: NOTIFICATION FORM -->
    <div id="notification-form-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="notification-form-title">Crear Notificaci贸n</h4>
                <button class="close-modal" onclick="closeModal('notification-form-modal')">&times;</button>
            </div>
            <form id="notification-form">
                <input type="hidden" id="notification-id-field" />
                <div class="input-group">
                    <label>T铆tulo</label>
                    <input type="text" id="notification-title-field" required />
                </div>
                <div class="input-group">
                    <label>Mensaje</label>
                    <textarea id="notification-message-field" rows="3" required></textarea>
                </div>
                <div class="input-group">
                    <label>Link / Enlace (Opcional)</label>
                    <input type="url" id="notification-link-field" placeholder="https://..." />
                </div>
                <button type="submit">Enviar Notificaci贸n</button>
            </form>
        </div>
    </div>

    <!-- MODAL: CONNECTED USERS LIST -->
    <div id="connected-today-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <h4>Conectados del D铆a <span id="connected-total-count"
                            style="font-size: 0.8em; color: #666; font-weight: normal;">(0)</span> <span
                            id="connection-mode-badge"
                            style="font-size: 0.6em; background: #eee; padding: 2px 5px; border-radius: 4px;">Cargando...</span>
                    </h4>
                    <button onclick="exportConnectedUsersPDF()" class="admin-btn"
                        style="background-color: #dc2626; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; cursor: pointer;">
                        <i class="fa-solid fa-file-pdf"></i> Exportar PDF
                    </button>
                </div>
                <button class="close-modal" onclick="closeModal('connected-today-modal')">&times;</button>
            </div>
            <div id="connected-users-container" style="max-height: 300px; overflow-y: auto;">
                <p>Cargando usuarios...</p>
            </div>
        </div>
    </div>

    <!-- MODAL: USER CONNECTION HISTORY -->
    <div id="user-history-modal" class="modal-overlay" style="z-index: 3001;">
        <div class="modal-content">
            <div class="modal-header">
                <h4 id="history-modal-title">Historial de Conexiones</h4>
                <button class="close-modal" onclick="closeModal('user-history-modal')">&times;</button>
            </div>
            <div id="user-history-list" style="max-height: 300px; overflow-y: auto;">
                <!-- History populated here -->
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD9p16QACzSifXaTl1TojcuUKDijuE77S0",
            authDomain: "backend-panel-vendedores.firebaseapp.com",
            projectId: "backend-panel-vendedores",
            storageBucket: "backend-panel-vendedores.firebasestorage.app",
            messagingSenderId: "24873830395",
            appId: "1:24873830395:web:ea6749407f991ee8226d5e",
            measurementId: "G-E4Z0Y849KF",
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Auth Logic
        const encodedAdminPassword = "NTM1MTUyNQ=="; // "5351525" base64
        const loginForm = document.getElementById("admin-login-form");
        const passwordInput = document.getElementById("admin-password");
        const loginError = document.getElementById("login-error");

        // Check session
        if (sessionStorage.getItem("adminAuth") === "true") {
            showPanel();
        }

        loginForm.addEventListener("submit", (e) => {
            e.preventDefault();
            const entered = passwordInput.value;
            if (btoa(entered) === encodedAdminPassword) {
                sessionStorage.setItem("adminAuth", "true");
                showPanel();
            } else {
                loginError.textContent = "Contrase帽a incorrecta";
            }
        });

        document.getElementById("logout-btn").addEventListener("click", () => {
            sessionStorage.removeItem("adminAuth");
            location.reload();
        });

        function showPanel() {
            document.getElementById("login-overlay").style.display = "none";
            document.getElementById("admin-wrapper").style.display = "flex";
            initDashboard();
            initNews();
            initTrainings();
            initSuggestions();
            initNotifications();
            initSocialConfig();
            initReviewConfig();
        }

        // Navigation Logic
        const navItems = document.querySelectorAll(".nav-item[data-section]");
        const sections = document.querySelectorAll(".content-section");

        navItems.forEach(item => {
            item.addEventListener("click", () => {
                const target = item.dataset.section;
                switchSection(target);
            });
        });

        function switchSection(sectionId) {
            // Update nav
            navItems.forEach(nav => {
                if (nav.dataset.section === sectionId) nav.classList.add("active");
                else nav.classList.remove("active");
            });
            // Update content
            sections.forEach(sec => {
                if (sec.id === sectionId) sec.classList.add("active");
                else sec.classList.remove("active");
            });

            // Refresh data based on section
            if (sectionId === 'news') loadNews();
            if (sectionId === 'trainings') loadTrainings();
            if (sectionId === 'suggestions') loadSuggestions();
            if (sectionId === 'notifications') loadNotifications();
            if (sectionId === 'social-config') loadSocialConfig();
            if (sectionId === 'review-config') loadReviewConfig();

            // Close mobile menu if open
            const sidebarNav = document.querySelector('.sidebar-nav');
            if (window.innerWidth <= 768 && sidebarNav.classList.contains('mobile-open')) {
                sidebarNav.classList.remove('mobile-open');
            }
        }

        // Mobile Menu Toggle
        document.getElementById('mobile-menu-toggle').addEventListener('click', () => {
            document.querySelector('.sidebar-nav').classList.toggle('mobile-open');
        });

        // Makes switchSection global for inline calls
        window.switchSection = switchSection;

        window.openNewsModalAction = () => {
            switchSection('news');
            openNewsForm();
        };

        window.openTrainingModalAction = () => {
            switchSection('trainings');
            openTrainingForm();
        };

        window.openNotificationModalAction = () => {
            switchSection('notifications');
            openNotificationForm();
        };

        // --- DASHBOARD LOGIC (Active Users) ---
        function initDashboard() {
            const activeUsersCountEl = document.getElementById('active-users-count');
            const activeUsersListEl = document.getElementById('active-users-list');
            const twoMinutesAgo = new Date(Date.now() - 2 * 60 * 1000);

            db.collection('active_sessions')
                .where('last_seen', '>', twoMinutesAgo)
                .onSnapshot(snapshot => {
                    const activeCount = snapshot.size;
                    const activeUsers = [];
                    snapshot.forEach(doc => activeUsers.push(doc.data().userName));

                    if (activeUsersListEl) {
                        if (activeUsers.length > 0) {
                            activeUsersListEl.innerHTML = activeUsers.map(name =>
                                `<span class="user-tag"><i class="fa-solid fa-circle fa-2xs" style="color: #22c55e;"></i>${name}</span>`
                            ).join('');
                        } else {
                            activeUsersListEl.innerHTML = `<p style="color: #6b7280;">No hay usuarios activos.</p>`;
                        }
                    }
                    if (activeUsersCountEl) activeUsersCountEl.textContent = activeCount;
                });
        }

        // --- CONNECTED TODAY LOGIC ---
        let currentConnectedUsers = []; // Store for PDF export (unique users)
        let allConnectionsData = []; // Store all raw connections for history

        window.openConnectedTodayModal = async () => {
            document.getElementById('connected-today-modal').style.display = 'flex';
            const container = document.getElementById('connected-users-container');
            container.innerHTML = '<p>Cargando datos...</p>';
            currentConnectedUsers = [];
            allConnectionsData = [];

            const startOfDay = new Date();
            startOfDay.setHours(0, 0, 0, 0);

            try {
                // NUEVA ESTRATEGIA: Buscar documentos con isHistory=true en active_sessions
                const usersMap = {};
                document.getElementById('connection-mode-badge').textContent = "Cargando...";
                document.getElementById('connection-mode-badge').style.color = "#666";

                // Buscar todos los documentos de historial (isHistory=true)
                const historySnapshot = await db.collection('active_sessions')
                    .where('isHistory', '==', true)
                    .get();

                console.log(" Documentos de historial encontrados:", historySnapshot.size);

                if (historySnapshot.empty) {
                    console.log("No logs found in session_logs, trying fallback to active_sessions...");
                    document.getElementById('connection-mode-badge').textContent = "Modo: Tiempo Real (Fallback)";
                    document.getElementById('connection-mode-badge').style.color = "#d9534f"; // Red for fallback

                    // FALLBACK: Try active_sessions for backward compatibility
                    const fallbackSnapshot = await db.collection('active_sessions')
                        .where('last_seen', '>', startOfDay)
                        .get(); // Also remove orderBy here just in case

                    if (fallbackSnapshot.empty) {
                        container.innerHTML = '<p>No se encontraron conexiones hoy.</p>';
                        document.getElementById('connected-total-count').textContent = '(0)';
                        return;
                    }

                    // Process fallback data (same structure logic but simpler)
                    fallbackSnapshot.forEach(doc => {
                        const data = doc.data();
                        const name = data.userName || 'Usuario desconocido';
                        const timeObj = data.last_seen ? data.last_seen.toDate() : null;
                        if (!timeObj) return;
                        const timeStr = timeObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                        // In fallback, we only have one record per user (the latest one usually), 
                        // so 'count' will be 1 and 'history' will have just this time.
                        if (!usersMap[name]) {
                            usersMap[name] = {
                                name: name,
                                firstTime: timeStr,
                                count: 1,
                                history: [timeStr]
                            };
                            // We push to global data too
                            allConnectionsData.push({ name, time: timeStr });
                        }
                    });

                } else {
                    document.getElementById('connection-mode-badge').textContent = "Modo: Historial (Activo)";
                    document.getElementById('connection-mode-badge').style.color = "#22c55e";

                    // Procesar documentos de historial
                    historySnapshot.forEach(doc => {
                        const data = doc.data();
                        const timeObj = data.connectionTime ? data.connectionTime.toDate() : null;

                        if (!timeObj || timeObj < startOfDay) return;

                        const userName = data.userName;
                        const sessionId = data.sessionId || userName;

                        if (!usersMap[sessionId]) {
                            usersMap[sessionId] = {
                                name: userName,
                                times: [],
                                count: 0
                            };
                        }

                        usersMap[sessionId].times.push(timeObj);
                        usersMap[sessionId].count++;
                    });

                    // Procesar y ordenar tiempos
                    Object.values(usersMap).forEach(user => {
                        if (user.times && user.times.length > 0) {
                            user.times.sort((a, b) => a - b);
                            user.firstTime = user.times[0].toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                            user.history = user.times.map(t => t.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }));
                        }
                    });
                }

                // Convert map to array and Sort by First Connection Time
                const sortedUsers = Object.values(usersMap).sort((a, b) => {
                    return a.firstTime.localeCompare(b.firstTime);
                });

                currentConnectedUsers = sortedUsers; // Update for PDF export

                // Update count (Total UNIQUE users)
                document.getElementById('connected-total-count').textContent = `(${sortedUsers.length})`;

                let html = '<ul style="list-style: none; padding: 0;">';
                sortedUsers.forEach(u => {
                    html += `
                        <li style="padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-weight: 500;">${u.name}</span>
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <span style="cursor: pointer; background: #e0e7ff; color: #4338ca; padding: 4px 10px; border-radius: 20px; font-size: 0.9em; font-weight: 700; display: inline-block; min-width: 20px; text-align: center;" 
                                      onclick="openUserHistory('${u.name}')" title="Ver historial">
                                    ${u.count}
                                </span>
                                <small style="color: #666; width: 60px; text-align: right;">${u.firstTime}</small>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                container.innerHTML = html;

            } catch (error) {
                console.error("Error fetching connected users:", error);
                container.innerHTML = '<p style="color: red;">Error al cargar usuarios. Verifica la consola.</p>';
            }
        };

        window.openUserHistory = (userName) => {
            const user = currentConnectedUsers.find(u => u.name === userName);
            if (!user) return;

            const container = document.getElementById('user-history-list');
            document.getElementById('history-modal-title').textContent = `Historial: ${userName}`;

            let html = '<ul style="list-style: none; padding: 0;">';
            // Reverse history to show latest first? Or Keep Chronological? 
            // "Historial" usually implies a timeline. Let's show chronological as collected (ASC).
            user.history.forEach((time, index) => {
                html += `
                    <li style="padding: 8px; border-bottom: 1px solid #f3f4f6; display: flex; justify-content: space-between;">
                        <span>Conexi贸n #${index + 1}</span>
                        <span style="font-weight: 600; color: #555;">${time}</span>
                    </li>
                 `;
            });
            html += '</ul>';

            container.innerHTML = html;
            document.getElementById('user-history-modal').style.display = 'flex';
        };

        window.exportConnectedUsersPDF = () => {
            if (!currentConnectedUsers || currentConnectedUsers.length === 0) {
                alert("No hay datos para exportar.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const dateStr = new Date().toLocaleDateString();

            // Header
            doc.setFontSize(18);
            doc.text("Reporte de Usuarios Conectados", 14, 22);
            doc.setFontSize(12);
            doc.text(`Fecha: ${dateStr}`, 14, 32);
            doc.text(`Total Usuarios nicos: ${currentConnectedUsers.length}`, 14, 38);

            // Table
            doc.autoTable({
                startY: 45,
                head: [['Usuario', 'Primera Conexi贸n', 'Total Accesos']],
                body: currentConnectedUsers.map(u => [u.name, u.firstTime, u.count]),
                theme: 'striped',
                headStyles: { fillColor: [79, 70, 229] }
            });

            doc.save(`Reporte_Conectados_${dateStr.replace(/\//g, '-')}.pdf`);
        };

        // --- NEWS LOGIC ---
        function initNews() {
            loadNews();
            document.getElementById("add-news-btn").onclick = () => openNewsForm();
            document.getElementById("news-form").onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById("news-id-field").value;
                const data = {
                    title: document.getElementById("news-title-field").value,
                    description: document.getElementById("news-description-field").value,
                    category: document.getElementById("news-category-field").value,
                    link: document.getElementById("news-link-field").value || "",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                };
                if (id) await db.collection("news").doc(id).update(data);
                else await db.collection("news").add(data);
                closeModal("news-form-modal");
                loadNews();
            };
        }

        async function loadNews() {
            const container = document.getElementById("admin-news-list");
            container.innerHTML = "<p>Cargando...</p>";
            const snapshot = await db.collection("news").orderBy("timestamp", "desc").get();
            container.innerHTML = "";
            snapshot.forEach(doc => {
                const news = { id: doc.id, ...doc.data() };
                const item = document.createElement("div");
                item.className = "admin-item";
                item.innerHTML = `
                <div class="admin-item-content">
                    <small>${news.category.toUpperCase()}</small>
                    <p><strong>${news.title}</strong></p>
                    <p style="color: #666; font-size: 0.9em;">${news.description.substring(0, 100)}...</p>
                    ${news.link ? `<small style="color: blue;"><a href="${news.link}" target="_blank"> Link adjunto</a></small>` : ''}
                </div>
                <div class="admin-item-actions">
                    <button class="action-btn btn-edit" onclick="editNews('${news.id}')"><i class="fa-solid fa-pencil"></i></button>
                    <button class="action-btn btn-delete" onclick="deleteItem('news', '${news.id}')"><i class="fa-solid fa-trash"></i></button>
                    <button class="action-btn btn-reset" onclick="resetReactions('${news.id}')" title="Resetear Reacciones"><i class="fa-solid fa-arrows-rotate"></i></button>
                </div>
            `;
                container.appendChild(item);
            });
        }

        window.editNews = async (id) => {
            const doc = await db.collection("news").doc(id).get();
            const data = doc.data();
            document.getElementById("news-id-field").value = id;
            document.getElementById("news-title-field").value = data.title;
            document.getElementById("news-description-field").value = data.description;
            document.getElementById("news-category-field").value = data.category;
            document.getElementById("news-link-field").value = data.link || "";
            document.getElementById("news-form-title").textContent = "Editar Noticia";
            document.getElementById("news-form-modal").style.display = "flex";
        };

        // --- TRAININGS LOGIC ---
        function initTrainings() {
            loadTrainings();
            document.getElementById("add-training-btn").onclick = () => openTrainingForm();
            document.getElementById("training-form").onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById("training-id-field").value;
                const data = {
                    date: document.getElementById("training-date-field").value,
                    title: document.getElementById("training-title-field").value,
                };
                if (id) await db.collection("trainings").doc(id).update(data);
                else await db.collection("trainings").add(data);
                closeModal("training-form-modal");
                loadTrainings();
            };
        }

        async function loadTrainings() {
            const container = document.getElementById("admin-trainings-list");
            container.innerHTML = "<p>Cargando...</p>";
            const snapshot = await db.collection("trainings").orderBy("date", "desc").get();
            container.innerHTML = "";
            snapshot.forEach(doc => {
                const t = { id: doc.id, ...doc.data() };
                const item = document.createElement("div");
                item.className = "admin-item";
                item.innerHTML = `
                <div class="admin-item-content">
                    <small>${t.date}</small>
                    <p>${t.title}</p>
                </div>
                <div class="admin-item-actions">
                    <button class="action-btn btn-edit" onclick="editTraining('${t.id}')"><i class="fa-solid fa-pencil"></i></button>
                    <button class="action-btn btn-delete" onclick="deleteItem('trainings', '${t.id}')"><i class="fa-solid fa-trash"></i></button>
                </div>
            `;
                container.appendChild(item);
            });
        }

        window.editTraining = async (id) => {
            const doc = await db.collection("trainings").doc(id).get();
            const data = doc.data();
            document.getElementById("training-id-field").value = id;
            document.getElementById("training-date-field").value = data.date;
            document.getElementById("training-title-field").value = data.title;
            document.getElementById("training-form-title").textContent = "Editar Capacitaci贸n";
            document.getElementById("training-form-modal").style.display = "flex";
        };

        // --- SUGGESTIONS LOGIC ---
        function initSuggestions() {
            loadSuggestions();
        }

        // --- NOTIFICATIONS LOGIC ---
        function initNotifications() {
            loadNotifications();
            document.getElementById("add-notification-btn").onclick = () => openNotificationForm();
            document.getElementById("notification-form").onsubmit = async (e) => {
                e.preventDefault();
                const id = document.getElementById("notification-id-field").value;
                const data = {
                    title: document.getElementById("notification-title-field").value,
                    message: document.getElementById("notification-message-field").value,
                    link: document.getElementById("notification-link-field").value || "",
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                };
                if (id) {
                    await db.collection("notifications").doc(id).update(data);
                } else {
                    await db.collection("notifications").add(data);
                    // Solo enviamos Push si es una notificaci贸n NUEVA
                    sendPushNotification(data.title, data.message, data.link);
                }
                closeModal("notification-form-modal");
                loadNotifications();
            };
        }

        // Funci贸n para enviar Push a OneSignal
        async function sendPushNotification(title, message, link) {
            const ONE_SIGNAL_APP_ID = "24c23510-f95c-49ca-873b-67dbfcff5740";
            const REST_API_KEY = "tu clave aqui";

            const headers = {
                "Content-Type": "application/json; charset=utf-8",
                "Authorization": `Basic ${REST_API_KEY}`
            };

            const body = {
                app_id: ONE_SIGNAL_APP_ID,
                headings: { "en": title, "es": title },
                contents: { "en": message, "es": message },
                included_segments: ["Total Subscriptions"], // Env铆a a todos los suscritos
                url: link || undefined // Abre el link si existe
            };

            try {
                const response = await fetch("https://onesignal.com/api/v1/notifications", {
                    method: "POST",
                    headers: headers,
                    body: JSON.stringify(body)
                });
                const result = await response.json();
                console.log("Push enviado:", result);
            } catch (error) {
                console.error("Error enviando Push:", error);
            }
        }

        // --- NOTIFICATION PDF EXPORT ---
        window.notificationsData = {}; // Store for PDF export

        window.exportNotificationReadsPDF = (id) => {
            const data = window.notificationsData[id];
            if (!data || !data.readBy || data.readBy.length === 0) {
                alert("No hay lecturas registradas para exportar.");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const dateStr = new Date().toLocaleDateString();

            // Header
            doc.setFontSize(16);
            doc.text("Reporte de Lecturas de Notificaci贸n", 14, 22);

            doc.setFontSize(12);
            doc.text(`Noticia: ${data.title}`, 14, 32);
            doc.text(`Fecha del Reporte: ${dateStr}`, 14, 40);
            doc.text(`Total Le铆dos: ${data.readBy.length}`, 14, 46);

            // Table
            // Map plain strings to array for autotable
            const tableBody = data.readBy.map(user => [user]);

            doc.autoTable({
                startY: 55,
                head: [['Le铆do por Usuario']],
                body: tableBody,
                theme: 'striped',
                headStyles: { fillColor: [79, 70, 229] }
            });

            doc.save(`Reporte_Notificacion_${id}_${dateStr.replace(/\//g, '-')}.pdf`);
        };

        async function loadNotifications() {
            const container = document.getElementById("admin-notifications-list");
            container.innerHTML = "<p>Cargando...</p>";
            const snapshot = await db.collection("notifications").orderBy("timestamp", "desc").get();
            container.innerHTML = "";

            // Reset data store
            window.notificationsData = {};

            snapshot.forEach(doc => {
                const n = { id: doc.id, ...doc.data() };
                const date = n.timestamp ? n.timestamp.toDate().toLocaleString() : 'Reciente';
                const readBy = n.read_by || [];
                const readCount = readBy.length;

                // Store for export
                window.notificationsData[n.id] = {
                    title: n.title,
                    readBy: readBy
                };

                // Generate users list HTML
                const usersList = readCount > 0
                    ? readBy.map(u => `<div style="font-size:0.85em; border-bottom:1px solid #eee; padding:2px;">${u}</div>`).join('')
                    : '<div style="font-size:0.85em; color:#888;">Nadie a煤n</div>';

                const item = document.createElement("div");
                item.className = "admin-item";
                item.innerHTML = `
                <div class="admin-item-content">
                    <small>${date}</small>
                    <p><strong>${n.title}</strong></p>
                    <p style="color: #666; font-size: 0.9em;">${n.message}</p>
                    ${n.link ? `<small style="color: blue;"><a href="${n.link}" target="_blank"> Link adjunto</a></small>` : ''}
                    
                    <div style="margin-top: 8px;">
                        <details>
                            <summary style="cursor:pointer; list-style:none; color: var(--brand); font-size:0.9em; font-weight:600; display:flex; align-items:center; gap: 10px;">
                                <span><i class="fa-solid fa-eye"></i> Visto por ${readCount} personas <span style="font-size:0.8em; color:#999;">(ver lista)</span></span>
                                ${readCount > 0 ? `<button onclick="exportNotificationReadsPDF('${n.id}')" title="Exportar PDF" style="background: none; border: none; color: #dc2626; cursor: pointer; padding: 0;"><i class="fa-solid fa-file-pdf"></i></button>` : ''}
                            </summary>
                            <div style="background: #f8f9fa; padding: 8px; border-radius: 6px; margin-top: 5px; max-height: 150px; overflow-y: auto; border: 1px solid #e9ecef;">
                                ${usersList}
                            </div>
                        </details>
                    </div>
                </div>
                <div class="admin-item-actions">
                     <button class="action-btn btn-edit" onclick="editNotification('${n.id}')"><i class="fa-solid fa-pencil"></i></button>
                    <button class="action-btn btn-delete" onclick="deleteItem('notifications', '${n.id}')"><i class="fa-solid fa-trash"></i></button>
                </div>
            `;
                container.appendChild(item);
            });
        }

        window.editNotification = async (id) => {
            const doc = await db.collection("notifications").doc(id).get();
            const data = doc.data();
            document.getElementById("notification-id-field").value = id;
            document.getElementById("notification-title-field").value = data.title;
            document.getElementById("notification-message-field").value = data.message;
            document.getElementById("notification-link-field").value = data.link || "";
            document.getElementById("notification-form-title").textContent = "Editar Notificaci贸n";
            document.getElementById("notification-form-modal").style.display = "flex";
        };

        // --- SOCIAL CONFIG LOGIC ---
        function initSocialConfig() {
            document.getElementById("social-config-form").onsubmit = async (e) => {
                e.preventDefault();
                const data = {
                    imageUrl: document.getElementById("social-image-url").value,
                    instagramUrl: document.getElementById("social-instagram-url").value,
                    facebookUrl: document.getElementById("social-facebook-url").value,
                    linkedinUrl: document.getElementById("social-linkedin-url").value,
                };
                try {
                    await db.collection("config").doc("social_networks").set(data);
                    alert("Configuraci贸n de redes guardada correctamente.");
                } catch (error) {
                    console.error("Error guardando redes:", error);
                    alert("Hubo un error al guardar.");
                }
            };
        }

        async function loadSocialConfig() {
            try {
                const doc = await db.collection("config").doc("social_networks").get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById("social-image-url").value = data.imageUrl || "";
                    document.getElementById("social-instagram-url").value = data.instagramUrl || "";
                    document.getElementById("social-facebook-url").value = data.facebookUrl || "";
                    document.getElementById("social-linkedin-url").value = data.linkedinUrl || "";
                }
            } catch (error) {
                console.error("Error cargando redes:", error);
            }
        }

        // --- REVIEW CONFIG LOGIC ---
        function initReviewConfig() {
            document.getElementById("review-config-form").onsubmit = async (e) => {
                e.preventDefault();
                const data = {
                    imageUrl: document.getElementById("review-image-url").value,
                    branchName: document.getElementById("review-branch-name-input").value,
                };
                try {
                    await db.collection("config").doc("featured_review").set(data);
                    alert("Configuraci贸n de rese帽a guardada correctamente.");
                } catch (error) {
                    console.error("Error guardando rese帽a:", error);
                    alert("Hubo un error al guardar.");
                }
            };
        }

        async function loadReviewConfig() {
            try {
                const doc = await db.collection("config").doc("featured_review").get();
                if (doc.exists) {
                    const data = doc.data();
                    document.getElementById("review-image-url").value = data.imageUrl || "";
                    document.getElementById("review-branch-name-input").value = data.branchName || "";
                }
            } catch (error) {
                console.error("Error cargando rese帽a:", error);
            }
        }

        async function loadSuggestions() {
            const container = document.getElementById("admin-suggestions-list");
            container.innerHTML = "<p>Cargando...</p>";
            const snapshot = await db.collection("sugerencias").orderBy("fecha", "desc").get();
            container.innerHTML = "";
            if (snapshot.empty) {
                container.innerHTML = "<p>No hay sugerencias recientes.</p>";
                return;
            }
            snapshot.forEach(doc => {
                const s = { id: doc.id, ...doc.data() };
                const date = s.fecha ? s.fecha.toDate().toLocaleString() : 'Fecha desconocida';
                const item = document.createElement("div");
                item.className = "admin-item";
                // Correct wrapping for suggestions
                item.innerHTML = `
                <div class="admin-item-content" style="white-space: normal; overflow: visible;">
                    <small>${date}</small>
                    <p style="white-space: pre-wrap;">${s.sugerencia}</p>
                </div>
                <div class="admin-item-actions">
                    <button class="action-btn btn-delete" onclick="deleteItem('sugerencias', '${s.id}')" title="Eliminar"><i class="fa-solid fa-trash"></i></button>
                </div>
            `;
                container.appendChild(item);
            });
        }

        // --- SHARED UTILS ---
        window.deleteItem = async (collection, id) => {
            if (confirm("驴Seguro que quer茅s eliminar este elemento?")) {
                await db.collection(collection).doc(id).delete();
                if (collection === 'news') {
                    try { await db.collection('reactions').doc(id).delete(); } catch (e) { }
                }
                alert("Eliminado correctamente");
                // Reload current section
                if (collection === 'news') loadNews();
                if (collection === 'trainings') loadTrainings();
                if (collection === 'sugerencias') loadSuggestions();
                if (collection === 'notifications') loadNotifications();
            }
        };

        window.resetReactions = async (id) => {
            if (confirm("驴Resetear reacciones de esta noticia?")) {
                await db.collection("reactions").doc(id).set({ "": 0, "わ": 0, "": 0 });
                alert("Reacciones reseteadas.");
            }
        };

        // Modal helpers
        function openNewsForm() {
            document.getElementById("news-form").reset();
            document.getElementById("news-id-field").value = "";
            document.getElementById("news-form-title").textContent = "Crear Noticia";
            document.getElementById("news-form-modal").style.display = "flex";
        }
        function openTrainingForm() {
            document.getElementById("training-form").reset();
            document.getElementById("training-id-field").value = "";
            document.getElementById("training-form-title").textContent = "Agregar Capacitaci贸n";
            document.getElementById("training-form-modal").style.display = "flex";
        }
        function openNotificationForm() {
            document.getElementById("notification-form").reset();
            document.getElementById("notification-id-field").value = "";
            document.getElementById("notification-form-title").textContent = "Crear Notificaci贸n";
            document.getElementById("notification-form-modal").style.display = "flex";
        }
        window.closeModal = (id) => {
            document.getElementById(id).style.display = "none";
        };

        // Close modal on outside click
        window.onclick = function (event) {
            if (event.target.classList.contains('modal-overlay')) {
                event.target.style.display = "none";
            }
        }

    </script>
</body>

</html>